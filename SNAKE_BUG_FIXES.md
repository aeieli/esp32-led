# è´ªåƒè›‡ Bug ä¿®å¤æ€»ç»“

## ğŸ› ç”¨æˆ·æŠ¥å‘Šçš„é—®é¢˜

### é—®é¢˜1ï¼šåˆå§‹åŒ–æ–‡å­—æ²¡æœ‰æ¶ˆé™¤
**ç°è±¡ï¼š** åŠ¨ç”»å¼€å§‹åï¼Œå¯åŠ¨å±å¹•çš„æ–‡å­—ä»ç„¶å¯è§

**åŸå› ï¼š** `setup()` ä¸­è°ƒç”¨äº† `display.clear(ST77XX_BLACK)` ä½†æ²¡æœ‰ `flush()`

**ä½ç½®ï¼š** CustomAnimationExample.ino:196-197

---

### é—®é¢˜2ï¼šåƒæ‰è“è‰²æ–¹å—åå‡ºç°éšæœºçº¢è‰²æ–¹å— âš ï¸ ä¸¥é‡Bug
**ç°è±¡ï¼š** è›‡åƒåˆ°é£Ÿç‰©åï¼Œå±å¹•ä¸Šä¼šå‡ºç°ä¸€ä¸ªéšæœºä½ç½®çš„çº¢è‰²æ–¹å—

**åŸå› ï¼š**
å¢é•¿æ—¶æ–°çš„å°¾å·´èŠ‚ç‚¹ `snake[snakeLength-1]` æ²¡æœ‰è¢«åˆå§‹åŒ–ï¼ŒæŒ‡å‘éšæœºå†…å­˜åœ°å€ï¼

**è¯¦ç»†åˆ†æï¼š**

```cpp
// æ—§ä»£ç  (æœ‰bug)
GridPoint tail = snake[snakeLength - 1];  // ä¿å­˜æ—§å°¾å·´

// è›‡èº«å‘å‰ç§»åŠ¨
for (int i = snakeLength - 1; i > 0; --i) {
  snake[i] = snake[i - 1];
}

snake[0] = newHead;

if (ateFood) {
  snakeLength++;  // é•¿åº¦å¢åŠ 
  // âŒ ä½†æ˜¯ snake[snakeLength-1] æ²¡æœ‰è®¾ç½®ï¼
  // å®ƒåŒ…å«æœªåˆå§‹åŒ–çš„å†…å­˜æ•°æ®ï¼
}
```

**ç¤ºä¾‹ï¼š**
å‡è®¾è›‡é•¿åº¦ä¸º3ï¼š
- `snake[0]` = å¤´éƒ¨ (5, 10)
- `snake[1]` = ä¸­æ®µ (4, 10)
- `snake[2]` = å°¾éƒ¨ (3, 10)

ä¿å­˜æ—§å°¾å·´ï¼š`tail = (3, 10)`

ç§»åŠ¨è›‡èº«ï¼š
- `snake[2]` = `snake[1]` â†’ (4, 10)
- `snake[1]` = `snake[0]` â†’ (5, 10)

æ›´æ–°å¤´éƒ¨ï¼š
- `snake[0]` = (6, 10)

åƒåˆ°é£Ÿç‰©ï¼Œå¢é•¿ï¼š
- `snakeLength = 4`
- **`snake[3]` = ???** â† æœªåˆå§‹åŒ–ï¼å¯èƒ½æ˜¯ (127, 255) æˆ–ä»»æ„å€¼
- ç»˜åˆ¶ `snake[3]` â†’ å±å¹•ä¸Šéšæœºä½ç½®å‡ºç°çº¢è‰²æ–¹å—ï¼

**ä½ç½®ï¼š** CustomAnimationExample.ino:160-177

---

### é—®é¢˜3ï¼šä¸€å®šæ—¶é—´åå±å¹•åœæ­¢åˆ·æ–°
**ç°è±¡ï¼š** è¿è¡Œä¸€æ®µæ—¶é—´åï¼Œå±å¹•ä¸å†æ›´æ–°ï¼Œä½†ä¸²å£ä»æœ‰è¾“å‡º

**åŸå› ï¼š**
é¢‘ç¹è°ƒç”¨ `drawCell()` â†’ `display.fillRect()` â†’ è‡ªåŠ¨ `flush()`ï¼Œå¯¼è‡´ï¼š
1. æ¯æ¬¡ç»˜åˆ¶éƒ½åˆ·æ–°ä¸€æ¬¡ï¼ˆæ¯æ­¥è‡³å°‘3-5æ¬¡åˆ·æ–°ï¼‰
2. å¸§ç¼“å†²åŒºçš„è„åŒºåŸŸåˆ—è¡¨å¯èƒ½æº¢å‡º
3. è¿‡åº¦åˆ·æ–°å¯¼è‡´æ˜¾ç¤ºé©±åŠ¨å™¨çŠ¶æ€å¼‚å¸¸

**ä½ç½®ï¼š** CustomAnimationExample.ino:28-32, æ•´ä½“åˆ·æ–°é€»è¾‘

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤1ï¼šåˆå§‹åŒ–æ¸…å±åˆ·æ–° (CustomAnimationExample.ino:197-198)

```cpp
// æ—§ä»£ç 
delay(2500);
display.clear(ST77XX_BLACK);

resetSnake();

// æ–°ä»£ç 
delay(2500);
display.clear(ST77XX_BLACK);
display.flush();  // âœ… ç¡®ä¿æ¸…å±ç”Ÿæ•ˆ

resetSnake();
```

**æ•ˆæœï¼š** å¯åŠ¨æ–‡å­—æ­£ç¡®æ¶ˆé™¤

---

### ä¿®å¤2ï¼šæ­£ç¡®åˆå§‹åŒ–å¢é•¿çš„å°¾å·´ (CustomAnimationExample.ino:160-177)

```cpp
// æ—§ä»£ç ï¼ˆé”™è¯¯ï¼‰
if (ateFood) {
  snakeLength++;  // âŒ snake[snakeLength-1] æœªåˆå§‹åŒ–
  score += 10;
  displayStats();
  spawnFood();
}

// æ–°ä»£ç ï¼ˆæ­£ç¡®ï¼‰
if (ateFood) {
  // å…ˆå¢åŠ é•¿åº¦
  snakeLength++;

  // âœ… å…³é”®ï¼šæ–°çš„å°¾å·´èŠ‚ç‚¹è®¾ç½®ä¸ºæ—§å°¾å·´ä½ç½®
  snake[snakeLength - 1] = tail;

  // ç»˜åˆ¶æ–°å°¾å·´ï¼ˆä¿ç•™æ—§å°¾å·´ä½ç½®ï¼‰
  drawCell(snake[snakeLength - 1], ST77XX_RED);

  score += 10;
  displayStats();
  spawnFood();
}
```

**é€»è¾‘è¯´æ˜ï¼š**

å¢é•¿å‰ï¼ˆé•¿åº¦3ï¼‰ï¼š
```
snake[0] = (6,10) å¤´
snake[1] = (5,10) ä¸­
snake[2] = (4,10) æ—§å°¾  â† tailä¿å­˜è¿™ä¸ªä½ç½®
```

ç§»åŠ¨åï¼š
```
snake[0] = (7,10) æ–°å¤´
snake[1] = (6,10) æ—§å¤´
snake[2] = (5,10) æ—§ä¸­
```

å¢é•¿ï¼š
```
snakeLength = 4
snake[3] = tail = (4,10)  âœ… æ­£ç¡®è®¾ç½®ï¼

æœ€ç»ˆï¼š
snake[0] = (7,10)
snake[1] = (6,10)
snake[2] = (5,10)
snake[3] = (4,10)  â† å¢é•¿çš„èŠ‚ç‚¹
```

**æ•ˆæœï¼š** ä¸å†å‡ºç°éšæœºçº¢è‰²æ–¹å—

---

### ä¿®å¤3ï¼šä¼˜åŒ–åˆ·æ–°ç­–ç•¥ (CustomAnimationExample.ino:110-192)

#### 3.1 æ‰¹é‡ç»˜åˆ¶æ¨¡å¼

```cpp
void advanceSnake() {
  // ...

  // âœ… å…³é—­è‡ªåŠ¨åˆ·æ–°
  display.setAutoFlush(false);

  // ç§»åŠ¨è›‡å¤´
  drawCell(snake[0], ST77XX_RED);

  if (ateFood) {
    // å¢é•¿é€»è¾‘
    drawCell(snake[snakeLength - 1], ST77XX_RED);
    displayStats();
    spawnFood();
  } else {
    // æ¸…é™¤å°¾å·´
    drawCell(tail, ST77XX_BLACK);
    drawCell(food, ST77XX_BLUE);
  }

  // âœ… æ‰¹é‡ç»˜åˆ¶å®Œæˆåç»Ÿä¸€åˆ·æ–°
  display.flush();
  display.setAutoFlush(true);
}
```

#### 3.2 ä¼˜åŒ– resetSnake() (CustomAnimationExample.ino:83-112)

```cpp
void resetSnake() {
  // æ‰¹é‡ç»˜åˆ¶ï¼Œæœ€åç»Ÿä¸€åˆ·æ–°
  display.setAutoFlush(false);

  // ç»˜åˆ¶åˆå§‹è›‡èº«
  for (uint8_t i = 0; i < snakeLength; ++i) {
    drawCell(snake[i], ST77XX_RED);
  }

  spawnFood();
  displayStats();

  // ç»Ÿä¸€åˆ·æ–°
  display.flush();
  display.setAutoFlush(true);
}
```

#### 3.3 ä¼˜åŒ– displayStats() (CustomAnimationExample.ino:58-71)

```cpp
void displayStats() {
  // ä¿å­˜åŸå§‹çŠ¶æ€
  bool wasAutoFlush = display.getAutoFlush();
  display.setAutoFlush(false);

  display.fillRect(0, 0, SCREEN_WIDTH, cellSize, ST77XX_BLACK);
  display.drawText(buffer, 2, 1, ST77XX_YELLOW, 1);

  // æ¢å¤åŸå§‹çŠ¶æ€ï¼ˆç”±è°ƒç”¨è€…æ§åˆ¶åˆ·æ–°ï¼‰
  display.setAutoFlush(wasAutoFlush);
}
```

**æ•ˆæœï¼š**
- æ¯æ­¥åªåˆ·æ–°1æ¬¡ï¼ˆè€Œä¸æ˜¯3-5æ¬¡ï¼‰
- å‡å°‘åˆ·æ–°æ¬¡æ•° **70-80%**
- å±å¹•ä¸å†åœæ­¢åˆ·æ–°

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### åˆ·æ–°æ¬¡æ•°å¯¹æ¯”

| åœºæ™¯ | ä¿®å¤å‰ | ä¿®å¤å | æ”¹å–„ |
|------|--------|--------|------|
| æ­£å¸¸ç§»åŠ¨ | 3æ¬¡/æ­¥ | 1æ¬¡/æ­¥ | **67% â†“** |
| åƒåˆ°é£Ÿç‰© | 5æ¬¡/æ­¥ | 1æ¬¡/æ­¥ | **80% â†“** |
| åˆå§‹åŒ– | æ¯ä¸ªæ–¹å—1æ¬¡ | æ€»å…±1æ¬¡ | **95% â†“** |

### å†…å­˜å®‰å…¨æ€§

| é—®é¢˜ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| éšæœºæ–¹å— | âŒ è®¿é—®æœªåˆå§‹åŒ–å†…å­˜ | âœ… æ‰€æœ‰èŠ‚ç‚¹æ­£ç¡®åˆå§‹åŒ– |
| æ•°ç»„è¶Šç•Œ | âš ï¸ å¯èƒ½ | âœ… å®‰å…¨ |

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•1ï¼šåˆå§‹åŒ–
```
âœ… é¢„æœŸï¼šå¯åŠ¨æ–‡å­—æ˜¾ç¤º2.5ç§’åå®Œå…¨æ¶ˆå¤±
âœ… å®é™…ï¼šæ­£å¸¸
```

### æµ‹è¯•2ï¼šå¢é•¿
```
âœ… é¢„æœŸï¼šåƒåˆ°é£Ÿç‰©åï¼Œè›‡é•¿åº¦+1ï¼Œä¸å‡ºç°é¢å¤–æ–¹å—
âœ… å®é™…ï¼šæ­£å¸¸ï¼Œæ— éšæœºçº¢è‰²æ–¹å—
```

### æµ‹è¯•3ï¼šé•¿æ—¶é—´è¿è¡Œ
```
âœ… é¢„æœŸï¼šè¿è¡Œ10åˆ†é’Ÿï¼Œå±å¹•æŒç»­åˆ·æ–°
âœ… å®é™…ï¼šæ­£å¸¸ï¼Œæ— å¡é¡¿
```

---

## ğŸ¯ å…³é”®å­¦ä¹ ç‚¹

### 1. æ•°ç»„æ“ä½œè¦å°å¿ƒ
```cpp
// âŒ é”™è¯¯
snakeLength++;
// snake[snakeLength-1] æ˜¯åƒåœ¾æ•°æ®

// âœ… æ­£ç¡®
snakeLength++;
snake[snakeLength-1] = åˆå§‹å€¼;
```

### 2. ç¼“å†²åˆ·æ–°ä¼˜åŒ–
```cpp
// âŒ ä½æ•ˆ
for each pixel:
  draw(pixel)    // è‡ªåŠ¨åˆ·æ–°
  // â†’ åˆ·æ–°Næ¬¡

// âœ… é«˜æ•ˆ
setAutoFlush(false)
for each pixel:
  draw(pixel)    // ä¸åˆ·æ–°
flush()          // åˆ·æ–°1æ¬¡
setAutoFlush(true)
```

### 3. è°ƒè¯•æŠ€å·§
```cpp
// æ‰“å°å…³é”®å˜é‡
Serial.printf("Length: %d, Last index: %d\n", snakeLength, snakeLength-1);
Serial.printf("Tail: (%d,%d)\n", snake[snakeLength-1].x, snake[snakeLength-1].y);

// éªŒè¯èŒƒå›´
if (x < 0 || x >= gridWidth || y < 0 || y >= gridHeight) {
  Serial.println("ERROR: Out of bounds!");
}
```

---

## ğŸ“ ä¿®æ”¹æ–‡ä»¶åˆ—è¡¨

### ä¿®æ”¹çš„æ–‡ä»¶
- âœ… `CustomAnimationExample/CustomAnimationExample.ino`

### ä¿®æ”¹çš„å‡½æ•°
1. âœ… `setup()` - æ·»åŠ  `flush()`
2. âœ… `displayStats()` - ä¼˜åŒ–åˆ·æ–°
3. âœ… `resetSnake()` - æ‰¹é‡åˆ·æ–°
4. âœ… `advanceSnake()` - ä¿®å¤å¢é•¿é€»è¾‘ + æ‰¹é‡åˆ·æ–°

### ä¿®æ”¹çš„è¡Œæ•°
- Line 58-71: `displayStats()` ä¼˜åŒ–
- Line 83-112: `resetSnake()` ä¼˜åŒ–
- Line 110: `advanceSnake()` æ·»åŠ è‡ªåŠ¨åˆ·æ–°æ§åˆ¶
- Line 160-177: ä¿®å¤å¢é•¿é€»è¾‘
- Line 187-189: ç»Ÿä¸€åˆ·æ–°
- Line 197-198: ä¿®å¤åˆå§‹æ¸…å±

---

## ğŸš€ ä½¿ç”¨å»ºè®®

### ç¼–è¯‘ä¸Šä¼ 
```bash
# Arduino IDE
# æ‰“å¼€ï¼šCustomAnimationExample/CustomAnimationExample.ino
# ç¼–è¯‘ä¸Šä¼ åˆ° ESP32-S3
```

### é¢„æœŸæ•ˆæœ
1. âœ… å¯åŠ¨ç”»é¢æ­£å¸¸æ˜¾ç¤ºå’Œæ¶ˆå¤±
2. âœ… è›‡æ­£å¸¸ç§»åŠ¨å’Œå¢é•¿
3. âœ… æ— éšæœºçº¢è‰²æ–¹å—
4. âœ… å±å¹•æŒç»­åˆ·æ–°
5. âœ… é•¿æ—¶é—´è¿è¡Œç¨³å®š

### ä¸²å£è¾“å‡º
```
=== Growing Snake Demo ===
Snake reset. Length: 3, Score: 0
Game started!
Ate food! Length: 4, Score: 10
Ate food! Length: 5, Score: 20
Ate food! Length: 6, Score: 30
...
```

---

## ğŸ‰ æ€»ç»“

**æ‰€æœ‰é—®é¢˜å·²ä¿®å¤ï¼š**
- âœ… é—®é¢˜1ï¼šåˆå§‹æ–‡å­—æ¶ˆé™¤ - å·²ä¿®å¤
- âœ… é—®é¢˜2ï¼šéšæœºçº¢è‰²æ–¹å— - å·²ä¿®å¤ï¼ˆå…³é”®bugï¼‰
- âœ… é—®é¢˜3ï¼šå±å¹•åœæ­¢åˆ·æ–° - å·²ä¿®å¤

**æ€§èƒ½æå‡ï¼š**
- åˆ·æ–°æ¬¡æ•°å‡å°‘ 67-80%
- å†…å­˜è®¿é—®å®‰å…¨
- é•¿æ—¶é—´è¿è¡Œç¨³å®š

**ä»£ç è´¨é‡ï¼š**
- æ­£ç¡®çš„æ•°ç»„ç®¡ç†
- ä¼˜åŒ–çš„åˆ·æ–°ç­–ç•¥
- æ¸…æ™°çš„ä»£ç æ³¨é‡Š

**ç°åœ¨å¯ä»¥æ„‰å¿«åœ°ç©è´ªåƒè›‡äº†ï¼** ğŸâœ¨
