# ESP32-LED 蓝牙配对和WiFi配网使用指南

## 📋 目录

- [功能概述](#功能概述)
- [快速开始](#快速开始)
- [BLE蓝牙配对](#ble蓝牙配对)
- [WiFi配网](#wifi配网)
- [手机端控制](#手机端控制)
- [支持的指令](#支持的指令)
- [故障排除](#故障排除)

---

## 功能概述

本项目为ESP32-S3 IPS240显示屏添加了以下功能：

- ✅ **BLE蓝牙配对**：设备启动后自动开始BLE广播，手机可以连接
- ✅ **WiFi配网**：通过BLE发送WiFi凭证，实现自动配网
- ✅ **远程控制**：通过BLE发送指令控制显示内容、亮度等
- ✅ **数据上报**：ESP32可以主动向手机发送状态信息
- ✅ **配置持久化**：WiFi配置保存在Flash中，重启后自动连接

---

## 快速开始

### 1. 上传代码

使用Arduino IDE打开 `esp32-ips240.ino` 并上传到ESP32-S3开发板。

### 2. 观察启动流程

设备启动后，显示屏会依次显示：

1. **启动画面** (1.5秒)
2. **BLE状态** - 显示 "Device: ESP32-LED" (1.5秒)
3. **WiFi状态** - 如果未配置，显示 "Not Configured" (1.5秒)
4. **就绪画面** - 显示BLE和WiFi状态 (1.5秒)
5. **自动演示模式** - 循环显示文本、图片、动画、图形

### 3. 打开串口监视器（可选）

波特率：**115200**

可以看到详细的初始化和运行日志。

---

## BLE蓝牙配对

### 设备信息

- **设备名称**: `ESP32-LED`
- **配对方式**: 自动配对（Just Works，无需PIN码）
- **服务UUID**: `4fafc201-1fb5-459e-8fcc-c5c9c331914b`

### 使用nRF Connect进行连接（推荐测试工具）

#### 1. 下载App

- **iOS**: App Store 搜索 "nRF Connect"
- **Android**: Google Play 搜索 "nRF Connect for Mobile"

#### 2. 扫描设备

1. 打开nRF Connect App
2. 点击 "SCAN" 按钮
3. 在设备列表中找到 "ESP32-LED"
4. 点击 "CONNECT"

#### 3. 查看服务

连接成功后，会看到以下服务：

```
Service: 4fafc201-1fb5-459e-8fcc-c5c9c331914b
  ├─ Command (Write)      beb5483e-36e1-4688-b7f5-ea07361b26a8
  ├─ Data (Notify)        beb5483e-36e1-4688-b7f5-ea07361b26a9
  ├─ WiFi SSID (Write)    beb5483e-36e1-4688-b7f5-ea07361b26aa
  ├─ WiFi Password (Write) beb5483e-36e1-4688-b7f5-ea07361b26ab
  └─ Status (Read/Notify) beb5483e-36e1-4688-b7f5-ea07361b26ac
```

---

## WiFi配网

### 方法一：通过nRF Connect配网

#### 步骤：

1. **连接到ESP32-LED**（参考上面的BLE配对步骤）

2. **发送WiFi SSID**
   - 找到特征值 `WiFi SSID (0x...26aa)`
   - 点击 ↑（上传图标）
   - 选择 "Text" 格式
   - 输入你的WiFi名称，例如：`MyHomeWiFi`
   - 点击 "SEND"

3. **发送WiFi密码**
   - 找到特征值 `WiFi Password (0x...26ab)`
   - 点击 ↑（上传图标）
   - 选择 "Text" 格式
   - 输入你的WiFi密码，例如：`mypassword123`
   - 点击 "SEND"

4. **观察显示屏**
   - 屏幕会显示 "Connecting WiFi"
   - 连接成功后显示IP地址和信号强度
   - 配置会自动保存，下次启动自动连接

#### 示例截图说明：

```
nRF Connect界面
├─ ESP32-LED (已连接)
│   └─ 自定义服务
│       ├─ WiFi SSID → 点击写入 "MyWiFi"
│       └─ WiFi Password → 点击写入 "12345678"
```

### 方法二：通过串口发送（仅用于调试）

如果你想通过串口手动配置，可以修改代码中的setup()函数。

---

## 手机端控制

### 发送指令

通过 `Command` 特征值（Write）发送指令。

#### 使用nRF Connect发送指令：

1. 找到 `Command` 特征值（UUID: ...26a8）
2. 点击 ↑（上传图标）
3. 选择 "Text" 格式
4. 输入指令（见下方支持的指令列表）
5. 点击 "SEND"

### 接收数据

通过 `Data` 特征值（Notify）接收ESP32发送的数据。

#### 使用nRF Connect接收数据：

1. 找到 `Data` 特征值（UUID: ...26a9）
2. 点击 ↓↓↓（三个向下箭头，启用Notify）
3. 发送指令后，会在这里收到ESP32的响应

---

## 支持的指令

### 文本显示

```
TEXT:Hello World
```
在屏幕中央显示文本 "Hello World"。

### 调整亮度

```
BRIGHTNESS:128
```
设置亮度为128（范围: 0-255）。

### 清屏

```
CLEAR
```
清空屏幕内容。

### 切换模式

```
MODE:DEMO
```
或简写：
```
DEMO
```
切换到自动演示模式（默认模式，每5秒循环显示：文本 → 图片 → 动画 → 图形 → 贪吃蛇）。

```
MODE:DEMO2
```
或简写：
```
DEMO2
```
切换到贪吃蛇游戏演示模式（持续运行贪吃蛇AI游戏，不自动切换）。

```
MODE:MANUAL
```
切换到手动模式（停止自动演示，完全由指令控制）。

**💡 提示**：发送任何控制指令（如TEXT、BRIGHTNESS等）时，系统会**自动**切换到手动模式，停止自动演示。如需恢复自动演示，发送 `MODE:DEMO` 或 `DEMO2` 即可。

### 获取状态

```
STATUS
```
或
```
GET_STATUS
```
返回设备状态（JSON格式），包括：
- 当前模式
- 运行时间（秒）
- 可用堆内存

返回示例：
```json
{"mode":"MANUAL","uptime":120,"heap":234567}
```

### 睡眠和唤醒

```
SLEEP
```
关闭屏幕（背光）。

```
WAKEUP
```
或
```
WAKE
```
打开屏幕（背光）。

### 重启设备

```
RESTART
```
或
```
REBOOT
```
重启ESP32设备（3秒后执行）。

---

## 完整使用示例

### 示例1：控制显示文本

1. 用nRF Connect连接到ESP32-LED
2. 发送指令：`TEXT:Temperature: 25C`
3. 屏幕显示：**Temperature: 25C**
4. 在Data特征值收到：`OK:Text displayed`

### 示例2：调整亮度

1. 发送指令：`BRIGHTNESS:50`
2. 屏幕亮度降低
3. 收到响应：`OK:Brightness set to 50`

### 示例3：获取设备状态

1. 发送指令：`STATUS`
2. 收到响应：`{"mode":"MANUAL","uptime":300,"heap":250000}`

### 示例4：WiFi配网完整流程

1. 连接ESP32-LED
2. 写入WiFi SSID特征值：`MyHomeWiFi`
3. 写入WiFi Password特征值：`MySecurePassword`
4. 观察屏幕显示连接过程
5. 连接成功后，Data特征值收到：`WiFi connected: 192.168.1.100`

---

## 故障排除

### 问题1：nRF Connect找不到设备

**可能原因**：
- 手机蓝牙未开启
- ESP32未正常启动
- 其他设备已连接（ESP32只支持一个BLE连接）

**解决方法**：
1. 确认手机蓝牙已开启
2. 重启ESP32设备
3. 在nRF Connect中刷新扫描

### 问题2：连接后立即断开

**可能原因**：
- 信号干扰
- 手机距离ESP32太远

**解决方法**：
1. 将手机靠近ESP32（建议1米内）
2. 重新连接

### 问题3：WiFi连接失败

**可能原因**：
- SSID或密码错误
- WiFi信号弱
- ESP32不支持5GHz WiFi（仅支持2.4GHz）

**解决方法**：
1. 确认SSID和密码正确
2. 确保使用2.4GHz WiFi
3. 将ESP32靠近路由器
4. 通过串口查看详细错误信息

### 问题4：发送指令无响应

**可能原因**：
- 指令格式错误
- 大小写不正确

**解决方法**：
1. 检查指令格式（参考"支持的指令"部分）
2. 指令关键字使用大写，例如：`TEXT:` 而不是 `text:`
3. 查看串口日志确认是否收到指令

### 问题5：屏幕显示异常

**可能原因**：
- 显示模块连接不良
- SPI引脚定义错误

**解决方法**：
1. 检查显示屏连接线
2. 确认引脚定义正确（见代码注释）
3. 重启设备

---

## 技术参数

### BLE参数

- **蓝牙版本**: BLE 4.2+
- **传输速率**: 约1KB/s
- **有效距离**: 室内10-20米
- **最大连接数**: 1个设备
- **配对方式**: Just Works（自动配对）

### WiFi参数

- **支持频段**: 2.4GHz（不支持5GHz）
- **支持加密**: WPA/WPA2
- **连接超时**: 15秒
- **自动重连**: 是

### 存储

- **配置存储**: ESP32 NVS（非易失性存储）
- **存储位置**: Flash分区
- **断电保持**: 是

---

## 开发者信息

### 项目结构

```
esp32-ips240/
├── esp32-ips240.ino        # 主程序
├── BLEManager.h/cpp        # BLE管理模块
├── WiFiManager.h/cpp       # WiFi管理模块
├── ConfigStorage.h/cpp     # 配置存储模块
├── CommandHandler.h/cpp    # 指令处理模块
├── Display.h/cpp           # 显示管理模块
├── FrameBuffer.h/cpp       # 帧缓冲模块
└── ExampleImages.h         # 示例图片
```

### 自定义开发

#### 添加新指令

1. 在 `CommandHandler.h` 中添加新的 `CMD_XXX` 枚举
2. 在 `CommandHandler.cpp` 的 `parseCommandType()` 中添加解析逻辑
3. 实现 `executeXXX()` 方法
4. 在 `handleCommand()` 中添加case分支

#### 修改BLE服务

编辑 `BLEManager.h` 中的UUID定义。

#### 自定义显示界面

修改 `esp32-ips240.ino` 中的 `showXXX()` 函数。

---

## 常见问题FAQ

**Q: 可以同时连接多个手机吗？**
A: 不可以。当前版本只支持一个BLE连接。

**Q: WiFi密码会明文传输吗？**
A: 当前版本是明文传输。如需加密，可以集成ESP32的安全BLE功能。

**Q: 能否开发专用的手机App？**
A: 可以。使用Flutter、React Native或原生开发，集成BLE库即可。

**Q: 断电后WiFi配置会丢失吗？**
A: 不会。配置保存在Flash中，重启后自动加载。

**Q: 如何清除WiFi配置？**
A: 发送指令或在代码中调用 `config.clearWiFiCredentials()`。

---

## 🎯 Hex指令快速参考（新增DEMO2）

### 演示模式切换

| 指令文本 | Hex值 | 说明 |
|---------|-------|------|
| `DEMO` | `44 45 4D 4F` | 自动循环演示（5种模式） |
| `MODE:DEMO` | `4D 4F 44 45 3A 44 45 4D 4F` | 同上（完整格式） |
| `DEMO2` | `44 45 4D 4F 32` | 贪吃蛇游戏演示 |
| `MODE:DEMO2` | `4D 4F 44 45 3A 44 45 4D 4F 32` | 同上（完整格式） |
| `MODE:MANUAL` | `4D 4F 44 45 3A 4D 41 4E 55 41 4C` | 手动控制模式 |

### 快速复制使用

```
# 自动循环演示（文本→图片→动画→图形→贪吃蛇）
44 45 4D 4F

# 贪吃蛇游戏演示
44 45 4D 4F 32

# 手动控制模式
4D 4F 44 45 3A 4D 41 4E 55 41 4C
```

---

## 更新日志

### v1.1.0 (2025-10-31)

- ✅ 添加贪吃蛇游戏演示模式
- ✅ 添加DEMO2指令（切换到贪吃蛇演示）
- ✅ 修复心跳动画显示问题
- ✅ 优化演示模式切换逻辑

### v1.0.0 (2025-10-31)

- ✅ 添加BLE蓝牙配对功能
- ✅ 添加WiFi配网功能
- ✅ 添加远程指令控制
- ✅ 添加配置持久化存储
- ✅ 完整的状态显示界面

---

## 许可证

本项目代码遵循MIT许可证。

---

## 支持

如有问题，请查看串口输出日志或参考本文档的故障排除部分。
